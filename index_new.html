<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Trendboard</title>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; display: flex; flex-direction: column; }
    main { flex: 1; }
    header { position: sticky; top: 0; background: rgba(255,255,255,.9); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,0,0,.12); z-index: 10; }
    @media (prefers-color-scheme: dark) { header { background: rgba(20,20,20,.85); border-bottom-color: rgba(255,255,255,.14); } }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 14px; }
    h1 { margin: 0; font-size: 16px; font-weight: 800; }
    .hint { font-size: 12px; opacity: .75; line-height: 1.45; margin-top: 6px; }
    .sectionTitle { margin: 16px 0 8px; font-size: 12px; letter-spacing: .08em; text-transform: uppercase; opacity: .7; color: #0020C2; }
    .subToolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 6px 0 10px; font-size: 12px; opacity: .92; }
    .sep { opacity: .55; }
    .select, .text { font-size: 12px; padding: 7px 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,.18); background: transparent; opacity: .95; outline: none; }
    .text { min-width: 220px; }
    @media (prefers-color-scheme: dark) { .select, .text { border-color: rgba(255,255,255,.18); } }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    @media (max-width: 860px) { .grid { grid-template-columns: 1fr; } }
    .item { border: 1px solid rgba(0,0,0,.12); border-radius: 14px; padding: 14px; display: flex; gap: 12px; justify-content: space-between; align-items: flex-start; background: rgba(255,255,255,.7); transition: transform .15s ease; }
    @media (prefers-color-scheme: dark) { .item { border-color: rgba(255,255,255,.14); background: rgba(40,40,40,.4); } }
    .item:hover { transform: translateY(-2px); }
    
    /* ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
    .item.status-cancel { background: rgba(255, 0, 0, 0.06); border-color: rgba(255, 0, 0, 0.2) !important; opacity: 0.8; }
    .item.status-correct { background: rgba(255, 165, 0, 0.06); border-color: rgba(255, 165, 0, 0.3) !important; }

    .left { flex: 1; display: grid; gap: 6px; min-width: 0; }
    .top { display: flex; gap: 8px; align-items: center; min-width: 0; }
    .tag { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.14); opacity: .8; white-space: nowrap; font-weight: 700; }
    .title { font-size: 14px; font-weight: 800; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .metaLine { font-size: 12px; opacity: .78; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 2px; }
    .metaPill { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.14); opacity: .85; white-space: nowrap; }
    .actions { display: grid; gap: 8px; min-width: 140px; }
    .btn { font-size: 12px; padding: 7px 10px; border-radius: 999px; border: 1px solid rgba(0,0,0,.18); background: transparent; cursor: pointer; opacity: .92; text-align: center; }
    .btn:hover { background: rgba(0,0,0,.05); }

    /* ë¶„ì„ ìš”ì•½ ë°” */
    .pps-summary-bar { grid-column: 1 / -1; display: flex; gap: 12px; flex-wrap: wrap; padding: 10px 14px; background: rgba(0, 32, 194, 0.05); border-radius: 12px; font-size: 12px; border: 1px solid rgba(0, 32, 194, 0.15); margin-bottom: 4px; }
    .summary-chip { font-weight: 800; color: #0020C2; }
    @media (prefers-color-scheme: dark) { .summary-chip { color: #78A0FF; } }

    footer { padding: 24px 0; text-align: center; font-size: 12px; opacity: .6; }
    .historyWrap { max-width: 1200px; margin: 20px auto; padding: 0 14px; }
    .historyList { border: 1px solid rgba(0,0,0,.12); border-radius: 14px; overflow: hidden; }
    .hrow { display: grid; grid-template-columns: 150px 1fr 100px; gap: 10px; padding: 10px; border-top: 1px solid rgba(0,0,0,.05); cursor: pointer; font-size: 12px; }
    .hrow:first-child { border-top: 0; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI Trendboard</h1>
    <div class="hint">AI íŠ¸ë Œë“œ / ë‚˜ë¼ì¥í„° í†µí•© ë ˆì´ë” / ì±„ìš© ì‹œê·¸ë„</div>

    <div class="sectionTitle">ë‚˜ë¼ì¥í„° í†µí•© ë ˆì´ë”</div>
    <div class="subToolbar">
      <span>í‚¤ì›Œë“œ:</span>
      <input class="text" id="ppsKeyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (AI, ë°ì´í„° ë“±)" value="AI" />
      <span class="sep">|</span>
      <button class="btn" id="ppsRefresh" style="min-width:100px;">í†µí•© ê²€ìƒ‰</button>
      <span id="ppsMeta" class="muted"></span>
    </div>
    <div class="grid" id="grid-pps"></div>
  </div>
</header>

<main></main>

<div class="historyWrap">
  <div class="sectionTitle">ìµœê·¼ ì ‘ì† ê¸°ë¡</div>
  <div class="historyList" id="historyList"></div>
</div>

<footer>conceived & built by cw park</footer>

<script>
  // --- History & Helpers ---
  const HISTORY_KEY = "radar_history_v2";
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function openAndLog(url, label, tag){
    const list = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    list.unshift({ time: new Date().toLocaleString(), label, tag, url });
    localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0, 50)));
    renderHistory();
    window.open(url, "_blank");
  }
  function renderHistory(){
    const box = document.getElementById("historyList");
    const list = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    box.innerHTML = list.map(h => `<div class="hrow" onclick="window.open('${h.url}','_blank')"><div>${h.time}</div><div><b>[${h.tag}]</b> ${h.label}</div><div style="text-align:right">â†—</div></div>`).join("") || "<div class='p-3 muted'>ê¸°ë¡ ì—†ìŒ</div>";
  }

  // --- PPS í†µí•© ê²€ìƒ‰ ë¡œì§ ---
  async function fetchPpsData(kind, q) {
    try {
      const r = await fetch(`/api/pps?kind=${kind}&q=${encodeURIComponent(q)}`);
      if (!r.ok) return [];
      const json = await r.json();
      return json.items || [];
    } catch (e) { return []; }
  }

  function renderPpsItems(items) {
    const grid = document.getElementById("grid-pps");
    grid.innerHTML = "";

    if (!items.length) {
      grid.innerHTML = "<div class='item'>ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }

    // ë°ì´í„° ë¶„ì„
    const orgMap = {}; let totalAmt = 0; let amtCount = 0;
    items.forEach(it => {
      if(it.org) orgMap[it.org] = (orgMap[it.org] || 0) + 1;
      const n = parseInt(it.amount.replace(/[^0-9]/g, ""));
      if(n > 0){ totalAmt += n; amtCount++; }
    });
    const topOrg = Object.entries(orgMap).sort((a,b)=>b[1]-a[1])[0];
    const avgAmt = amtCount > 0 ? Math.round(totalAmt/amtCount) : 0;

    // ìš”ì•½ ë°” ì¶”ê°€
    const summaryBar = document.createElement("div");
    summaryBar.className = "pps-summary-bar";
    summaryBar.innerHTML = `ğŸ“Š <b>í†µí•© ë¶„ì„:</b> ìµœë‹¤ ë°œì£¼ <span class="summary-chip">${topOrg?.[0]||"-"}</span>(${topOrg?.[1]||0}ê±´) | í‰ê·  ê·œëª¨ <span class="summary-chip">â‚©${avgAmt.toLocaleString()}</span> | ìµœì‹ ìˆœ ì •ë ¬`;
    grid.appendChild(summaryBar);

    // ë‚ ì§œìˆœ ì •ë ¬
    const sorted = items.sort((a,b) => b.date.localeCompare(a.date));

    sorted.forEach(it => {
      const el = document.createElement("div");
      el.className = "item";
      if(it.status?.includes("ì·¨ì†Œ")) el.classList.add("status-cancel");
      if(it.status?.includes("ì •ì •")) el.classList.add("status-correct");

      const icon = it.status?.includes("ì·¨ì†Œ") ? "âŒ" : it.status?.includes("ì •ì •") ? "âš ï¸" : "ğŸ“„";
      const tagColor = it.kind === "bid" ? "#0020C2" : it.kind === "award" ? "#228B22" : "#800080";
      
      el.innerHTML = `
        <div class="left">
          <div class="top">
            <span class="tag" style="color:${tagColor}; border-color:${tagColor}">${it.kind.toUpperCase()}</span>
            <span class="title" title="${it.title}">${icon} ${escapeHtml(it.title)}</span>
          </div>
          <div class="metaLine">
            <span class="metaPill">${it.date}</span>
            <span class="metaPill">${escapeHtml(it.org)}</span>
            <span class="metaPill" style="font-weight:800; color:var(--accent)">â‚©${it.amount}</span>
            ${it.status ? `<span class="metaPill">${it.status}</span>` : ""}
          </div>
          <div class="tip">${it.winner ? `ë‚™ì°°: ${it.winner}` : it.period ? `ê¸°ê°„: ${it.period}` : "ì…ì°° ì§„í–‰ ì¤‘"}</div>
        </div>
        <div class="actions">
          <button class="btn" onclick="openAndLog('${it.url}', '${escapeHtml(it.title)}', 'PPS')">ìƒì„¸ë³´ê¸° â†—</button>
        </div>
      `;
      grid.appendChild(el);
    });
  }

  async function performIntegratedSearch() {
    const q = document.getElementById("ppsKeyword").value.trim() || "AI";
    const meta = document.getElementById("ppsMeta");
    meta.textContent = "í†µí•© ê²€ìƒ‰ ì¤‘ (ì…ì°°+ë‚™ì°°+ê³„ì•½)...";

    // 3ê°€ì§€ API ë™ì‹œ í˜¸ì¶œ
    const results = await Promise.all([
      fetchPpsData("bid", q),
      fetchPpsData("award", q),
      fetchPpsData("contract", q)
    ]);

    const combinedItems = results.flat();
    renderPpsItems(combinedItems);
    meta.textContent = `${combinedItems.length}ê±´ì˜ ê¸°íšŒ ë°œê²¬`;
  }

  // --- Init ---
  document.getElementById("ppsRefresh").onclick = performIntegratedSearch;
  document.getElementById("ppsKeyword").onkeydown = e => { if(e.key === "Enter") performIntegratedSearch(); };
  
  renderHistory();
  performIntegratedSearch();
</script>
</body>
</html>
